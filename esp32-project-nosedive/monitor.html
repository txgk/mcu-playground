<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
	const aliases = {
		BME280: ['BME280-T', 'BME280-P', 'BME280-H'],
		TPA626: ['TPA626-SHUNT', 'TPA626-BUS', 'TPA626-A', 'TPA626-W'],
		PWM:    ['PWM1-FREQ', 'PWM1-DUTY', 'PWM2-FREQ', 'PWM2-DUTY'],
		POWER:  ['KILL-SWITCH', 'POWER-ON', 'CURRENT-ALERT'],
	}
	var chart = null
	var messages = ''
	var messages_count = 0
	var data = []
	var stream = null
	var follow_mode_threshold = 0
	function update_plots() {
		if (follow_mode_threshold == '0') {
			for (var i = 0; i < data.length; ++i) {
				chart.data.datasets[i].data = data[i]
			}
		} else {
			for (var i = 0; i < data.length; ++i) {
				chart.data.datasets[i].data = data[i].slice(-follow_mode_threshold)
			}
		}
		chart.update()
	}
	function update_follow_mode_threshold() {
		follow_mode_threshold = document.getElementById("limiter").value
		update_plots()
	}
	function get_color(color_index) {
		const index = color_index % 24 // This algorithm is designed for 24 colors!
		var r = 240 - 60 * Math.floor(index / 8)
		var g = r
		var b = r
		if ((index & 7) == 0) {
			g = Math.floor(r / 1.3)
			b = Math.floor(r / 6)
		} else if ((index & 7) == 7) {
			r = 100 * (2 - Math.floor(index / 8))
			g = b = r
		} else {
			if (index & 1) {
				r -= 80 * (3 - Math.floor(index / 8))
			}
			if (index & 2) {
				g -= 80 * (3 - Math.floor(index / 8))
			}
			if (index & 4) {
				b -= 80 * (3 - Math.floor(index / 8))
			}
		}
		return '#' + r.toString(16).padStart(2, '0') + g.toString(16).padStart(2, '0') + b.toString(16).padStart(2, '0')
	}
	function get_dataset_index_by_name(dataset_name) {
		for (let i = 0; i < chart.data.datasets.length; ++i) {
			if (dataset_name == chart.data.datasets[i].label) {
				return i
			}
		}
		const index = chart.data.datasets.length
		const scale = 'y' + index
		chart.options.scales[scale] = {
			display: 'auto',
			title: {display: true, text: dataset_name, padding: 0},
			border: {width: 4, color: get_color(index)},
			ticks: {font: {size: 9}},
			grace: '3%',
		}
		chart.data.datasets.push({
			label: dataset_name,
			data: [],
			borderWidth: 2,
			pointRadius: 1,
			showLine: true,
			animations: false,
			borderColor: get_color(index),
			backgroundColor: get_color(index),
			yAxisID: scale,
		})
		data[index] = []
		return index
	}
	function get_dataset_name(data_nick, index) {
		if (aliases[data_nick] && aliases[data_nick][index]) {
			return aliases[data_nick][index]
		}
		return data_nick + index
	}
	function connect_device() {
		if (stream != null) {
			return
		}
		stream = new EventSource(document.getElementById("address").value, {withCredentials: false})
		stream.onmessage = (event) => {
			console.log(event.data)
			messages += event.data + '\n'
			messages_count += 1
			data_divided_by_at = event.data.split('@')
			data_time_and_values = data_divided_by_at[1].split('=')
			data_nick = data_divided_by_at[0]
			data_time = data_time_and_values[0]
			chart.options.scales.x.max = parseInt(data_time)
			data_values = data_time_and_values[1].split(',')
			for (let i = 0; i < data_values.length; ++i) {
				data[get_dataset_index_by_name(get_dataset_name(data_nick, i))].push([data_time, data_values[i]])
			}
		}
		stream.onerror = (error) => {
			console.log("EventSource failed!", error)
		}
	}
	function disconnect_device() {
		if (stream != null) {
			stream.close()
			stream = null
		}
	}
	function download_messages() {
		if (messages.length < 1) {
			return
		}
		var downloader = document.createElement('a')
		var blob = new Blob([messages], {type: 'text/plain;charset=utf-8;'})
		downloader.href = URL.createObjectURL(blob)
		const current_date = new Date().toJSON()
		const file_name = current_date.slice(0, 10) + '-' + current_date.slice(11, 19).replace(/:/g, '-') + '.txt'
		downloader.setAttribute('download', file_name)
		downloader.click()
	}
	function refresh_content() {
		if (stream == null || stream.readyState == 2) {
			document.getElementById("status").innerHTML = '(отключен)'
		} else if (stream.readyState == 1) {
			document.getElementById("status").innerHTML = '(подключен)'
			update_plots()
		} else {
			document.getElementById("status").innerHTML = '(подключение)'
		}
		document.getElementById("messages_counter").innerHTML = messages_count
	}
	window.onload = function() {
		const ctx = document.getElementById('myChart')
		chart = new Chart(ctx, {
			type: 'scatter',
			data: {datasets: []},
			options: {
				plugins: {
					legend: {
						display: true,
					},
				},
				scales: {x: {type: 'linear', max: 1}},
				animation: false,
				spanGaps: true,
			},
		})
	}
	setInterval(refresh_content, 1000)
</script>
</head>
<body>
	<input id="address" value="http://192.168.4.1:222/all">
	<button id="connect" onclick="connect_device()">Подключиться</button>
	<button id="connect" onclick="disconnect_device()">Отключиться</button>
	<span id="status">(отключен)</span>
	<input id="limiter" type="number" min="0" onchange="update_follow_mode_threshold()" placeholder="Режим следования" autocomplete="off" style="width: 12em">
	<button onclick="download_messages()">Сохранить</button>
	<button>Загрузить</button>
	Количество сообщений в памяти: <span id='messages_counter'>0</span>
	<div><canvas id="myChart"></canvas></div>
</body>
</html>
