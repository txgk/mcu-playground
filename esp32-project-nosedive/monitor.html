<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
	var messages = ''
	var data = []
	var stream = null
	function get_color(index) {
		var base = 80 + 20 * Math.floor(index / 8)
		r = g = b = base
		if (index & 4) {
			r *= 2
			if (r > 255) r = 255
		}
		if (index & 2) {
			g *= 2
			if (g > 255) g = 255
		}
		if (index & 1) {
			b *= 2
			if (b > 255) b = 255
		}
		return '#' + r.toString(16) + g.toString(16) + b.toString(16)
	}
	var plotly_plots = []
	var plotly_layout = {uirevision: true, datarevision: 0, margin: {b: 30, l: 30, r: 0, t: 30}}
	function update_plots() {
		const limiter_value = document.getElementById("limiter").value
		for (var i = 0; i < data.length; ++i) {
			if (plotly_plots[i].visible) {
				if (limiter_value == '0') {
					plotly_plots[i].x = data[i].x
					plotly_plots[i].y = data[i].y
				} else {
					plotly_plots[i].x = data[i].x.slice(-limiter_value)
					plotly_plots[i].y = data[i].y.slice(-limiter_value)
				}
			}
		}
		plotly_layout.datarevision += 1
		Plotly.react(document.getElementById("plots"), plotly_plots, plotly_layout)
	}
	function setup_plots() {
		var plot_offset = 0
		plotly_layout['yaxis'].position = plot_offset
		for (let i = 1; i < data.length; ++i) {
			plot_offset += 0.02
			plotly_layout['yaxis' + (i + 1)].position = plot_offset
		}
	}
	function get_data_set_index(data_set_name) {
		for (let i = 0; i < data.length; ++i) {
			if (data_set_name == data[i].name) {
				return i
			}
		}
		data[data.length] = {name: data_set_name, x: [], y: []}
		if (data.length == 1) {
			axis_name = 'y'
			plotly_layout['yaxis'] = {
				visible: true,
				showline: true,
				color: get_color(data.length - 1),
				linewidth: 5,
			}
		} else {
			axis_name = 'y' + data.length
			plotly_layout['yaxis' + data.length] = {
				visible: true,
				showline: true,
				color: get_color(data.length - 1),
				linewidth: 5,
				overlaying: 'y',
				anchor: 'free',
			}
		}
		plotly_plots[data.length - 1] = {
			name: data_set_name,
			visible: true,
			type: 'scatter',
			x: [],
			y: [],
			yaxis: axis_name,
			marker: {color: get_color(data.length - 1)},
		}
		setup_plots()
		return data.length - 1
	}
	function connect_device() {
		if (stream != null) {
			return
		}
		stream = new EventSource(document.getElementById("address").value, {withCredentials: false})
		stream.onmessage = (event) => {
			console.log(event.data)
			messages += event.data + '\n'
			data_divided_by_at = event.data.split('@')
			data_time_and_values = data_divided_by_at[1].split('=')
			data_name = data_divided_by_at[0]
			data_time = data_time_and_values[0]
			data_values = data_time_and_values[1].split(',')
			for (let i = 0; i < data_values.length; ++i) {
				data_index = get_data_set_index(data_name + '-' + i)
				data[data_index].x.push(data_time)
				data[data_index].y.push(data_values[i])
			}
			update_plots()
		}
		stream.onerror = (error) => {
			console.log("EventSource failed!", error)
		}
	}
	function disconnect_device() {
		if (stream != null) {
			stream.close()
			stream = null
		}
	}
	function download_messages() {
		if (messages.length < 1) {
			return
		}
		var downloader = document.createElement('a')
		var blob = new Blob([messages], {type: 'text/plain;charset=utf-8;'})
		downloader.href = URL.createObjectURL(blob)
		downloader.setAttribute('download', 'log.txt')
		downloader.click()
	}
	function refresh_status() {
		if (stream == null || stream.readyState == 2) {
			document.getElementById("status").innerHTML = '(отключен)'
		} else if (stream.readyState == 1) {
			document.getElementById("status").innerHTML = '(подключен)'
		} else {
			document.getElementById("status").innerHTML = '(подключение)'
		}
	}
	setInterval(refresh_status, 1000)
</script>
</head>
<body>
	<input id="address" value="http://192.168.4.1:222/all">
	<button id="connect" onclick="connect_device()">Подкл.</button>
	<button id="connect" onclick="disconnect_device()">Откл.</button>
	<span id="status">(отключен)</span>
	<input id="limiter" type="number" min="0" onchange="update_plots()" placeholder="Режим следования" autocomplete="off" style="width: 12em">
	<button onclick="download_messages()">Сохранить</button>
	<button>Загрузить</button>
	<div id="plots" style="width: 98vw; height: 95vh;"></div>
</body>
</html>
