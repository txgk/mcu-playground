## Прошивание

1. Скачать последнюю версию прошивки (файл с расширением bin) на [странице выпусков](https://github.com/txgk/mcu-playground/releases).

2. [Скачать архив](https://github.com/espressif/esptool/releases) с выпуском `esptool` для вашей операционной системы.

3. Разархивировать архив.

4. Скопировать последнюю версию прошивки (файл с расширением bin) в папку разархивированного архива.

5. Подключить отладочную плату ESP32 по USB.

6. Открыть терминал от имени администратора.

7. Перейти в папку с разархивированным архивом в терминале.

| № | Linux                                                              | Micro$oft Window$                                                      |
|---|--------------------------------------------------------------------|------------------------------------------------------------------------|
| 8 | Исполнить команду `./esptool write_flash 0 release-YYYY-MM-DD.bin` | Исполнить команду `.\esptool.exe write_flash 0 release-YYYY-MM-DD.bin` |

(`YYYY-MM-DD` необходимо заменить на соответствующую bin файлу прошивки дату).

## Компиляция и прошивание

1. [Установить ESP-IDF](https://docs.espressif.com/projects/esp-idf/en/latest/esp32/get-started).

2. [Скачать zip архив с последним выпуском прошивки](https://github.com/txgk/mcu-playground/releases).

3. Распаковать скачанный zip архив.

4. Подключить отладочную плату ESP32 по USB.

| № | Linux                                                  | Micro$oft Window$                                      |
|---|--------------------------------------------------------|--------------------------------------------------------|
| 5 | Установить переменные окружения ESP-IDF                | Запустить `ESP-IDF Command Prompt`                     |
| 6 | Перейти в папку с распакованным архивом (команда `cd`) | Перейти в папку с распакованным архивом (команда `cd`) |
| 7 | Исполнить команду `idf.py set-target esp32`            | Исполнить команду `idf.py set-target esp32`            |
| 8 | Исполнить команду `idf.py flash`                       | Исполнить команду `idf.py flash`                       |

## Управление

Управление периферией ESP32 осуществляется путём отправления GET запросов по HTTP протоколу на адрес `192.168.4.1` в порт `333` по пути `set`. Для доступа к этому интерфейсу пользователь должен находится в одной локальной сети с ESP32, поэтому нужно обязательно подключиться к Wi-Fi точке доступа, созданной ESP32.

| Название точки доступа | Пароль точки доступа |
|------------------------|----------------------|
| demoproshivka          | elbereth             |

После подключения к Wi-Fi точке доступа, которую создала ESP32, можно начать отправлять команды в виде GET запросов. Для удобства пользователя на странице `http://192.168.4.1:333/panel` предоставлен интерфейс для формирования этих запросов путём простых нажатий на кнопки. Также есть возможность отправлять эти запросы вручную: например, чтобы отправить команду `restart`, можно воспользоваться консольной утилитой `curl`:

| Операционная система | Команда                                       |
|----------------------|-----------------------------------------------|
| Linux                | `curl http://192.168.4.1:333/set?restart`     |
| Micro$oft Window$    | `curl.exe http://192.168.4.1:333/set?restart` |

Список доступных команд:

| Название  | Описание                                      | Аргументы                                                    | Пример использования      |
|-----------|-----------------------------------------------|--------------------------------------------------------------|---------------------------|
| `pcaset`  | Настроить канал PCA9685                       | Индекс канала (0..15 или `all`), процент заполнения (0..100) | `/set?pcaset=6,50`        |
| `pcamax`  | Полностью включить канал PCA9685              | Индекс канала (0..15 или `all`)                              | `/set?pcamax=7`           |
| `pcaoff`  | Полностью выключить канал PCA9685             | Индекс канала (0..15 или `all`)                              | `/set?pcaoff=8`           |
| `pcafreq` | Установить частоту PCA9685                    | Частота в герцах (25..1500)                                  | `/set?pcafreq=500`        |
| `restart` | Перезапустить ESP32                           | Отсутствуют                                                  | `/set?restart`            |
| `esptemp` | Получить температуру ESP32 в градусах Цельсия | Отсутствуют                                                  | `/set?esptemp`            |
| `espinfo` | Получить системную информацию об ESP32        | Отсутствуют                                                  | `/set?espinfo`            |
| `meminfo` | Получить информацию о чипе W25Q128JV          | Отсутствуют                                                  | `/set?meminfo`            |

В одном запросе можно указать сразу несколько команд, разделив их символом `&` (например `/set?pcamax=7&pcaoff=8`). Команды будут выполнены в порядке слева направо.

## Мониторинг

Телеметрия, собираемая с устройств на плате, передаётся по протоколу WebSocket в ответ на запрос по адресу `192.168.4.1` в порт `222`. Для доступа к этому интерфейсу пользователь должен находится в одной локальной сети с ESP32, поэтому нужно обязательно подключиться к Wi-Fi точке доступа, созданной ESP32.

После подключения к Wi-Fi точке доступа, которую создала ESP32, можно начинать мониторинг платы. Для удобства пользователя на странице `http://192.168.4.1:333/monitor` предоставлен интерфейс для наблюдения за всеми данными в виде графиков. Также есть возможность собирать телеметрию вручную:

| Операционная система | Команда                         |
|----------------------|---------------------------------|
| Linux                | `curl ws://192.168.4.1:222`     |
| Micro$oft Window$    | `curl.exe ws://192.168.4.1:222` |

Сообщения, которые отправляются ESP32 после получения этого запроса, имеют следующий формат:

```
NAME@TIME=INFO\n
```

где

`NAME` - название канала, из которого сообщение пришло,

`TIME` - временная метка, измеряемая в миллисекундах с момента запуска ESP32,

`INFO` - данные сообщения,

`\n` - символ переноса строки (ASCII 10).
